<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Triones ScreenSync</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" href="/favicon.png">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{--bg:#0b0f14;--fg:#e7f0ff;--muted:#9fb4d0;--card:#101827;--accent:#3b82f6;--success:#10b981;--error:#ef4444}
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial;user-select:none}
  
  header{padding:16px;border-bottom:1px solid #1e293b;background:linear-gradient(135deg,#0d141c,#1a2332);text-align:center}
  h1{margin:0;font-size:22px;font-weight:600;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  
  main{max-width:900px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid #1e293b;border-radius:16px;padding:16px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  
  button{background:#1f2937;border:1px solid #2b3a4c;color:var(--fg);padding:12px 16px;border-radius:12px;cursor:pointer;font-size:16px;font-weight:500;transition:all 0.2s;min-height:48px}
  button:hover{background:#223144;transform:translateY(-1px)}
  button:active{transform:scale(0.98)}
  button:disabled{opacity:0.5;cursor:not-allowed}
  button.primary{background:var(--accent);border-color:var(--accent);color:white}
  button.primary:hover{background:#2563eb}
  
  .pill{border:1px solid #2a3a4d;color:var(--muted);padding:6px 12px;border-radius:999px;font-size:14px;font-weight:500}
  .pill.connected{background:var(--success);color:white;border-color:var(--success);animation:pulse 2s infinite}
  .pill.error{background:var(--error);color:white;border-color:var(--error)}
  .pill.scanning{background:var(--accent);color:white;border-color:var(--accent);animation:pulse 1s infinite}
  
  .swatch{width:48px;height:48px;border-radius:8px;border:2px solid #333;display:inline-block}
  .current-color{display:flex;align-items:center;gap:12px;padding:16px;background:#0a0f16;border-radius:12px;border:1px solid #1e293b;margin:12px 0}
  
  .slider-container{margin:12px 0}
  .slider-container label{display:flex;justify-content:space-between;margin-bottom:8px;font-weight:500}
  .slider-container input[type="range"]{width:100%;height:8px;border-radius:4px;background:#1e293b;outline:none;-webkit-appearance:none}
  .slider-container input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:24px;height:24px;border-radius:50%;background:var(--accent);cursor:pointer}
  .slider-container input[type="range"]::-moz-range-thumb{width:24px;height:24px;border-radius:50%;background:var(--accent);cursor:pointer;border:none}
  
  .preview-container{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:12px 0}
  #preview,#livePreview{width:160px;height:90px;border:1px solid #333;border-radius:10px;background:#000}
  
  .log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:13px;background:#0a0f16;border:1px solid #1e293b;border-radius:12px;max-height:200px;overflow:auto;padding:12px;white-space:pre-wrap}
  
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
  
  @media (max-width: 768px) {
    main{padding:12px}
    #preview,#livePreview{width:140px;height:78px}
  }
</style>
</head>
<body>
<header>
  <h1>Triones ScreenSync</h1>
</header>

<main>
  <section class="card">
    <div class="row">
      <button id="btnConnect" class="primary">Connect Lights</button>
      <button id="btnPick" disabled>Pick Screen</button>
      <span id="btState" class="pill">Not connected</span>
      <span id="capState" class="pill">No capture</span>
    </div>

    <div class="current-color">
      <span id="swatch" class="swatch" style="background:#000"></span>
      <div>
        <div id="rgbTxt" style="font-size:18px;font-weight:500">rgb(0,0,0)</div>
        <small style="color:var(--muted)">Current color</small>
      </div>
    </div>

    <div class="slider-container">
      <label>
        <span>Brightness (LED)</span>
        <span id="brightnessValue">255</span>
      </label>
      <input id="brightness" type="range" min="20" max="255" value="255" />
      <small style="color:var(--muted)">Controls LED brightness without changing colors</small>
    </div>

    <label style="display:flex;gap:8px;align-items:center">
      <input id="avoidWhite" type="checkbox" checked />
      <span>Avoid whites <small style="color:var(--muted)">(focus on colorful areas)</small></span>
    </label>

    <div class="preview-container">
      <div>
        <small style="color:var(--muted)">Analyzed</small>
        <canvas id="preview" width="160" height="90"></canvas>
      </div>
      <div>
        <small style="color:var(--muted)">Live preview</small>
        <video id="livePreview" autoplay playsinline muted width="160" height="90"></video>
      </div>
    </div>
  </section>

  <section class="card">
    <details>
      <summary style="cursor:pointer;font-weight:500;padding:4px 0">Connection Log</summary>
      <div id="log" class="log"></div>
    </details>
  </section>

  <video id="vid" autoplay playsinline muted style="display:none"></video>
  <canvas id="cnv" width="96" height="54" style="display:none"></canvas>
</main>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const log = m => { 
    const el = $("#log"); 
    const t = new Date().toLocaleTimeString(); 
    el.textContent += `[${t}] ${m}\n`; 
    el.scrollTop = el.scrollHeight; 
  };

  const btnConnect = $("#btnConnect");
  const btnPick = $("#btnPick");
  const btState = $("#btState");
  const capState = $("#capState");
  const avoidWhite = $("#avoidWhite");
  const brightness = $("#brightness");
  const brightnessValue = $("#brightnessValue");
  const swatch = $("#swatch");
  const rgbTxt = $("#rgbTxt");
  const vid = $("#vid");
  const cnv = $("#cnv");
  const preview = $("#preview");
  const pctx = preview.getContext("2d");
  const livePreview = $("#livePreview");

  let device = null, writeChar = null;
  let stream = null, running = false, lastRGB = [0,0,0];
  let inFlight = false, latestBuf = null, usePkt = 1;
  let lastBrightness = 255;

  brightness.addEventListener('input', () => {
    const val = brightness.value;
    brightnessValue.textContent = val;
    if (writeChar) {
      setBrightness(Number(val));
    }
  });

  function pkt56(r,g,b){return new Uint8Array([0x56,r,g,b,0x00,0xF0,0xAA]);}
  function pkt7e(r,g,b){return new Uint8Array([0x7E,0x07,0x05,0x03,r,g,b,0x10,0xEF]);}
  
  function setBrightness(level) {
    if (!writeChar) return;
    // Triones brightness command - works on many models
    const cmd = new Uint8Array([0x56, 0x00, 0x00, 0x00, level, 0x0F, 0xAA]);
    try {
      if (writeChar.properties.writeWithoutResponse) {
        writeChar.writeValueWithoutResponse(cmd);
      } else {
        writeChar.writeValue(cmd);
      }
      lastBrightness = level;
    } catch(e) {
      log("Brightness command failed (may not be supported)");
    }
  }

  async function kickSend(){
    if (inFlight || !writeChar || !latestBuf) return;
    inFlight = true;
    const buf = latestBuf; 
    latestBuf = null;
    try {
      if (writeChar.properties.writeWithoutResponse) {
        await writeChar.writeValueWithoutResponse(buf);
      } else {
        await writeChar.writeValue(buf);
      }
    } catch(e) {
      log("Write failed: " + e.message);
    } finally {
      inFlight = false;
      if (latestBuf) kickSend();
    }
  }

  function sendRGB(r,g,b){
    latestBuf = (usePkt===1) ? pkt56(r,g,b) : pkt7e(r,g,b);
    kickSend();
  }

  const UUIDS = [
    {s:"0000ffd5-0000-1000-8000-00805f9b34fb", c:"0000ffd9-0000-1000-8000-00805f9b34fb"},
    {s:"0000ffe5-0000-1000-8000-00805f9b34fb", c:"0000ffe9-0000-1000-8000-00805f9b34fb"},
    {s:"0000ffb0-0000-1000-8000-00805f9b34fb", c:"0000ffb2-0000-1000-8000-00805f9b34fb"},
  ];

  btnConnect.onclick = async () => {
    try{
      btState.textContent = "Scanning...";
      btState.className = "pill scanning";
      
      device = await navigator.bluetooth.requestDevice({
        filters:[
          { namePrefix:"Triones" },
          { namePrefix:"LEDBLE" }, 
          { namePrefix:"Happy" }, 
          { namePrefix:"ELK-BLEDOM" }
        ],
        optionalServices: UUIDS.map(u=>u.s)
      }).catch(() => navigator.bluetooth.requestDevice({
        acceptAllDevices:true, 
        optionalServices:UUIDS.map(u=>u.s)
      }));
      
      log(`Connecting to: ${device.name || "(unnamed)"}`);
      
      device.addEventListener("gattserverdisconnected", ()=>{ 
        writeChar = null; 
        btState.textContent = "Disconnected"; 
        btState.className = "pill error";
        log("Disconnected"); 
      });
      
      const server = await device.gatt.connect();

      for (const u of UUIDS){
        try{
          const svc = await server.getPrimaryService(u.s);
          const ch = await svc.getCharacteristic(u.c);
          if (ch.properties.write || ch.properties.writeWithoutResponse){ 
            writeChar = ch; 
            break; 
          }
        }catch(e){}
      }
      
      if(!writeChar) throw new Error("No writable characteristic found");
      
      btState.textContent = "Connected";
      btState.className = "pill connected";
      log("Connected successfully");
      
      try {
        await (writeChar.properties.writeWithoutResponse ? 
          writeChar.writeValueWithoutResponse(pkt56(2,2,2)) : 
          writeChar.writeValue(pkt56(2,2,2)));
        usePkt = 1;
        log("Using 0x56 format");
      } catch (_) {
        try {
          await (writeChar.properties.writeWithoutResponse ? 
            writeChar.writeValueWithoutResponse(pkt7e(2,2,2)) : 
            writeChar.writeValue(pkt7e(2,2,2)));
          usePkt = 2;
          log("Using 0x7E format");
        } catch (e2) {
          log("Init failed: " + e2.message);
        }
      }
      
      // Set initial brightness
      setBrightness(Number(brightness.value));
      
      btnPick.disabled = false;
    } catch(e) { 
      btState.textContent = "Error"; 
      btState.className = "pill error";
      log("Error: " + e.message); 
    }
  };

  function rgbToHsv(r,g,b){
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min; 
    let h=0;
    if(d!==0){ 
      switch(max){
        case r:h=((g-b)/d)%6;break;
        case g:h=(b-r)/d+2;break;
        case b:h=(r-g)/d+4;break;
      } 
      h*=60; 
      if(h<0)h+=360;
    }
    const s=max===0?0:d/max; 
    const v=max; 
    return [h,s,v];
  }

  function getDominantColor(ctx, w, h, avoidWhites){
    const sw=64, sh=Math.max(36, Math.round(sw*h/Math.max(w,1)));
    cnv.width=sw; cnv.height=sh;
    ctx.drawImage(vid, 0, 0, sw, sh); 
    const {data}=ctx.getImageData(0,0,sw,sh);
    
    const bins=36;
    const hist=new Array(bins).fill(0);
    const acc=Array.from({length:bins},()=>[0,0,0,0]);

    for(let i=0;i<data.length;i+=4){
      const r=data[i], g=data[i+1], b=data[i+2], a=data[i+3]; 
      if(a<250) continue;
      
      const [hue,s,v]=rgbToHsv(r,g,b);
      
      let weight = Math.pow(s, 2.2) * Math.pow(v, 1.2);
      
      if(avoidWhites){ 
        if(s < 0.15) weight *= 0.1;
        if(v > 0.88 && s < 0.30) weight *= 0.05;
      }
      
      const bin = Math.min(bins-1, Math.floor((hue/360)*bins));
      hist[bin] += weight; 
      acc[bin][0] += r*weight;
      acc[bin][1] += g*weight;
      acc[bin][2] += b*weight;
      acc[bin][3] += weight;
    }

    let maxBin=0, maxVal=-1; 
    for(let i=0;i<bins;i++){ 
      if(hist[i] > maxVal){
        maxVal = hist[i];
        maxBin = i;
      } 
    }
    
    const A = acc[maxBin]; 
    return A[3] > 0 ? [A[0]/A[3], A[1]/A[3], A[2]/A[3]] : [0,0,0];
  }

  btnPick.onclick = () => {
    navigator.mediaDevices.getDisplayMedia({ 
      video: { frameRate: { ideal: 30, max: 60 } }, 
      audio: false 
    }).then(s => {
      stream = s;
      vid.srcObject = stream;
      vid.play();
      livePreview.srcObject = stream;

      capState.textContent = "Capturing";
      capState.className = "pill connected";
      log("Screen capture started");
      
      stream.getVideoTracks()[0].addEventListener("ended", () => {
        running = false;
        capState.textContent = "Ended";
        capState.className = "pill";
        log("Capture stopped");
      });

      const startLoop = () => {
        log(`Size: ${vid.videoWidth}x${vid.videoHeight}`);
        running = true;
        
        const ctx = cnv.getContext("2d", {willReadFrequently:true});
        
        const loop = () => { 
          if(!running || !vid.videoWidth) return;
          
          const rgb = getDominantColor(ctx, vid.videoWidth, vid.videoHeight, avoidWhite.checked);
          
          const smooth = 0.3;
          const out = [
            Math.round(smooth*lastRGB[0] + (1-smooth)*rgb[0]),
            Math.round(smooth*lastRGB[1] + (1-smooth)*rgb[1]),
            Math.round(smooth*lastRGB[2] + (1-smooth)*rgb[2])
          ];
          lastRGB = out;

          // NO brightness scaling - send full color values
          let r = Math.max(0, Math.min(255, Math.round(out[0])));
          let g = Math.max(0, Math.min(255, Math.round(out[1])));
          let b = Math.max(0, Math.min(255, Math.round(out[2])));

          pctx.drawImage(cnv, 0, 0, preview.width, preview.height);
          
          swatch.style.background = `rgb(${r},${g},${b})`;
          rgbTxt.textContent = `rgb(${r},${g},${b})`;
          
          if ((r+g+b) < 6) { 
            r=Math.max(r,2); g=Math.max(g,2); b=Math.max(b,2); 
          }

          sendRGB(r, g, b);
          requestAnimationFrame(loop);
        };
        
        loop();
      };
      
      if (vid.readyState >= 2) startLoop();
      else vid.addEventListener("loadedmetadata", startLoop, {once:true});
      
    }).catch(e => {
      log("Capture error: " + e.message);
      capState.textContent = "Error";
      capState.className = "pill error";
    });
  };
})();
</script>
</body>
</html>
